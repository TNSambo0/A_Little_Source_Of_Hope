@model IEnumerable<ShoppingCart>
@{
    ViewData["Title"] = "Shoppping Cart";
}
<div class="p-4">
    @if (ViewBag.Cart != null)
    {
        <div class="d-flex mb-2">
            <h2>Shopping Cart</h2>
            <a asp-action="ClearCart" asp-controller="ShoppingCart" class="btn btn-primary ml-auto">Clear cart</a>
        </div>
        <table class="table table-hover">
            <thead>
                <tr>
                    <th scope="col">Image</th>
                    <th scope="col">Product Name</th>
                    <th scope="col">Description</th>
                    <th scope="col">Quantity</th>
                    <th scope="col">Price per Item</th>
                    <th scope="col">Total per Item</th>
                    <th scope="col">&nbsp;</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var obj in Model)
                {
                    <tr class="product-row">
                        <td>
                            <img src="~/@obj.ImageUrl" width="60" />
                        </td>
                        <td class="product-name">@obj.ProductName</td>
                        <td>@obj.Description</td>
                        <td>
                            @Html.DropDownList("Quantity",Enumerable.Range(1,obj.AvailableQuantity).Select(i => new SelectListItem{Text = i.ToString(), Value = i.ToString(), Selected=i==obj.Quantity?true:false}),new {@class="form-control product-Quantity"})
                        </td>
                        <td class="PricePerItem">@obj.PricePerItem</td>
                        <td class="TotalPerItem">@obj.TotalPerItem</td>
                        <td>
                            <div class="container">
                                <a class="btn btn-danger" asp-action="RemoveFromCart" asp-controller="ShoppingCart" asp-route-productId="@obj.ProductId">
                                    <i class="fa fa-trash" aria-hidden="true"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <div class="container mt-2">
            <div class="row">
                <div class="col-md-3 offset-9">
                    <div class="d-flex">
                        <div class="d-flex flex-column mr-1 font-weight-bold">
                            <label>Subtotal</label>
                            <label>VAT</label>
                            <label>Total <small class="font-weight-bold">(inc. vat)</small></label>
                        </div>
                        <div class="d-flex flex-column font-weight-bold ml-auto">
                            <label class="SubTotal">: R @ViewData["SubTotal"]</label>
                            <label class="VatOfSubTotal">: R @ViewData["VatOfSubTotal"]</label>
                            <label class="Total">: R @ViewData["Total"]</label>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 btn-checkout">Checkout</button>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="container text-center">
            <p>You do not have any items in cart, click <a asp-action="MarketPlace" asp-controller="Home"><b>here</b></a> to add one.</p>
        </div>
    }
</div>
<script>
    $(".product-Quantity").on("change", function () {
        var selectedQuantities = $(".product-Quantity :selected").text().split("");
        var SubTotal = 0;
        for (let i = 0; i < selectedQuantities.length; i++) {
            var productRow = $(".product-row")[i];
            let pricePerItem = productRow.getElementsByClassName("PricePerItem")[0].innerHTML.replace(": R ", "").replace(",", ".");
            let selectedQuantity = Number.parseInt(selectedQuantities[i]);
            let TotalPerItem = Math.round(((selectedQuantity * pricePerItem) + Number.EPSILON) * 100) / 100;
            SubTotal += TotalPerItem;
            $(".TotalPerItem").val(TotalPerItem);
        }
        let VAT = 0.14 * SubTotal;
        let VatOfSubTotal = Math.round((VAT + Number.EPSILON) * 100) / 100;
        let Total = Math.round(((SubTotal + VatOfSubTotal) + Number.EPSILON) * 100) / 100;
        $(".SubTotal").val(SubTotal);
        $(".VatOfSubTotal").val(VatOfSubTotal);
        $(".Total").val(Total);
    });
    $(".btn-checkout").on('click', function () {
        $.ajax({
            type: "GET",
            dataType: "JSON",
            contentType: "application/json; charset=utf-8",
            url: '/Payment/Payment',
            data: { categoryIds: DeleteItemsArray },
            success:
                function (response) {
                    if (response.Status == "error") {
                        alert("Error: " + response.Message);
                        console.log("Error: " + response.Message);
                    }
                    else {
                        var NumberofItems = $("#NumberofItems").val();
                        if (DeleteItemsArray.length == NumberofItems) {
                            while (DeleteItemsArray.length != 0) {
                                $(".row-" + DeleteItemsArray[0]).fadeOut("slow");
                                DeleteItemsArray.splice(0, 1);
                            }
                            $(".tm-product-table").fadeOut("slow");
                            $(".Create-Product-div").removeClass("d-none");
                        }
                        else {
                            while (DeleteItemsArray.length != 0) {
                                $(".row-" + DeleteItemsArray[0]).fadeOut("slow");
                                DeleteItemsArray.splice(0, 1);
                            }
                        }
                        alert("Success: " + response.Status);
                        console.log("Success: " + response.Message);
                        BtnDeleteSelectedItems();
                    }
                },
            error:
                function (response) {
                    console.log("Error: " + response.Message);
                    console.log("Error: " + response);
                    BtnDeleteSelectedItems();
                }
        });

    });

</script>